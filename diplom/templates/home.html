<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LMS Diploma - –°–∏—Å—Ç–µ–º–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .test-card:hover { transform: translateY(-5px); transition: 0.3s; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
<nav class="bg-blue-600 text-white p-4 shadow-lg">
    <div class="container mx-auto flex justify-between items-center">
        <h1 class="text-2xl font-bold">üéì EduTest</h1>

        <div id="auth-buttons" class="flex">
            <button onclick="showModal('login')"
                    class="bg-white text-blue-600 px-4 py-2 rounded-lg font-semibold mr-2 hover:bg-gray-100">
                –í—Ö–æ–¥
            </button>
            <button onclick="showModal('register')"
                    class="border border-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700">
                –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
            </button>
        </div>

        <div id="user-profile" class="hidden flex items-center">
            <span class="mr-2 text-blue-100">–ü—Ä–∏–≤–µ—Ç,</span>
            <span id="user-name" class="mr-4 font-bold text-white underline decoration-blue-300"></span>
            <button onclick="logout()"
                    class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg text-sm font-bold transition">
                –í—ã–π—Ç–∏
            </button>
        </div>
    </div>
</nav>

<main class="container mx-auto mt-10 p-4">
    <div id="tests-container" class="grid grid-cols-1 md:grid-cols-3 gap-6">
        {% if all_tests %}
        {% for test in all_tests %}
        <div class="bg-white p-6 rounded-xl shadow test-card border border-gray-200">
            <h3 class="text-xl font-bold mb-2 text-gray-800">{{ test.title }}</h3>
            <p class="text-gray-600 mb-4 font-medium italic">–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: {{ test.timer // 60 }} –º–∏–Ω.</p>
            <button onclick="startTest({{ test.id }})"
                    class="w-full bg-green-500 text-white py-2 rounded-lg font-bold hover:bg-green-600 transition shadow-sm">
                –ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç
            </button>
        </div>
        {% endfor %}
        {% else %}
        <div class="col-span-full bg-white p-10 rounded-xl shadow text-center">
            <p class="text-gray-500 text-lg">–¢–µ—Å—Ç—ã –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã.</p>
        </div>
        {% endif %}
    </div>
</main>

<div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white p-8 rounded-xl shadow-2xl w-96">
        <h2 id="modal-title" class="text-2xl font-bold mb-6 text-center text-gray-800 border-b pb-2"></h2>
        <form id="auth-form" class="space-y-4">
            <input type="text" id="username" placeholder="–õ–æ–≥–∏–Ω"
                   class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-400 outline-none" required>
            <div id="reg-fields" class="hidden">
                <input type="text" id="fullname" placeholder="–ü–æ–ª–Ω–æ–µ –∏–º—è (–§–ò–û)"
                       class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-400 outline-none">
            </div>
            <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å"
                   class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-400 outline-none" required>
            <button type="submit"
                    class="w-full bg-blue-600 text-white p-3 rounded-lg font-bold hover:bg-blue-700 transition">
                –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
            </button>
            <button type="button" onclick="closeModal()" class="w-full text-gray-500 mt-2 hover:underline">–û—Ç–º–µ–Ω–∞
            </button>
        </form>
    </div>
</div>

<script>
    let currentMode = 'login';

    // 1. –£–ª—É—á—à–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    async function checkAuth() {
        try {
        // –Ø–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –Ω–∞–º –Ω—É–∂–Ω—ã credentials (–∫—É–∫–∏)
        const res = await fetch(`/user/me`, {
            method: 'GET',
            headers: { 'Accept': 'application/json' }
        });

        const authButtons = document.getElementById('auth-buttons');
        const userProfile = document.getElementById('user-profile');
        const userNameDisplay = document.getElementById('user-name');

        if (res.ok) {
            const user = await res.json();
            authButtons.classList.add('hidden');
            userProfile.classList.remove('hidden');
            userNameDisplay.innerText = user.fullname;
        } else {
            // –ï—Å–ª–∏ –ø–æ–ª—É—á–∏–ª–∏ 401, –∑–Ω–∞—á–∏—Ç –∫—É–∫–∏ –Ω–µ—Ç –∏–ª–∏ –æ–Ω–∞ –Ω–µ–≤–∞–ª–∏–¥–Ω–∞
            authButtons.classList.remove('hidden');
            userProfile.classList.add('hidden');
        }
    } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:", e);
    }
}

    // 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –≤—Ö–æ–¥ (Login)
    document.getElementById('auth-form').onsubmit = async (e) => {
        e.preventDefault();
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;

        if (currentMode === 'login') {
            const formData = new URLSearchParams();
            formData.append('username', username);
            formData.append('password', password);

            const res = await fetch(`/user/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: formData,
                credentials: 'include' // –í–∞–∂–Ω–æ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫—É–∫
            });

            if (res.ok) {
                console.log("–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ");
                location.reload();
            } else {
                const data = await res.json();
                alert("–û—à–∏–±–∫–∞: " + (data.detail || "–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å"));
            }
        } else {
            // –ö–æ–¥ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –æ—Å—Ç–∞–µ—Ç—Å—è –ø—Ä–µ–∂–Ω–∏–º
            const fullname = document.getElementById('fullname').value;
            const res = await fetch(`/user/register`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username, password, fullname})
            });

            if (res.ok) {
                alert("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É.");
                showModal('login');
            } else {
                const data = await res.json();
                alert("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: " + (data.detail || "–û—à–∏–±–∫–∞"));
            }
        }
    };

    function showModal(mode) {
        currentMode = mode;
        document.getElementById('modal').classList.remove('hidden');
        document.getElementById('modal-title').innerText = mode === 'login' ? '–í—Ö–æ–¥' : '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è';
        document.getElementById('reg-fields').classList.toggle('hidden', mode === 'login');
    }

    function closeModal() { document.getElementById('modal').classList.add('hidden'); }

    async function logout() {
        await fetch(`/user/logout`, { method: 'POST', credentials: 'include' });
        location.reload();
    }

    function startTest(id) {
        if (document.getElementById('user-profile').classList.contains('hidden')) {
            alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –ø—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç.");
            showModal('login');
            return;
        }
        alert("–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞ ‚Ññ" + id);
    }

    // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É
    checkAuth();
</script>
</body>
</html>