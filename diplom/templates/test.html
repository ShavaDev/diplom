<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduTest ‚Äî –ü—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 min-h-screen">
<nav class="bg-blue-600 text-white p-4 shadow-lg">
    <div class="container mx-auto flex justify-between items-center">
        <a href="/" class="text-2xl font-bold">üéì EduTest</a>
        <div class="text-blue-100 text-sm">–ü—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞</div>
    </div>
</nav>

<main class="container mx-auto mt-8 p-4">
    <section class="bg-white rounded-2xl shadow p-6 mb-6">
        <h1 class="text-2xl font-bold text-gray-800">–¢–µ—Å—Ç ‚Ññ<span id="test-id">{{ test_id }}</span></h1>
        <p class="text-gray-500 mt-2">
            –û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–û—Ç–ø—Ä–∞–≤–∏—Ç—å¬ª, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç.
        </p>
        <div id="load-error" class="hidden mt-4 p-4 rounded-lg bg-red-50 text-red-700"></div>
    </section>

    <section id="questions-section" class="space-y-6"></section>

    <section class="mt-8">
        <button id="submit-btn"
                class="w-full md:w-auto bg-green-500 text-white py-3 px-6 rounded-xl font-bold hover:bg-green-600 transition disabled:opacity-50"
                disabled>
            –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç—ã
        </button>
        <div id="result-card" class="hidden mt-6 bg-white shadow rounded-2xl p-6 border border-green-100">
            <h2 class="text-xl font-bold text-gray-800">–†–µ–∑—É–ª—å—Ç–∞—Ç</h2>
            <div id="result-content" class="mt-3 text-gray-600 space-y-2"></div>
            <a id="certificate-link"
               class="hidden mt-4 inline-flex items-center text-blue-600 font-semibold hover:underline"
               href="#">
                –°–∫–∞—á–∞—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
            </a>
        </div>
    </section>
</main>

<script>
    const testId = Number("{{ test_id }}");
    const submitBtn = document.getElementById('submit-btn');
    const questionsSection = document.getElementById('questions-section');
    const loadError = document.getElementById('load-error');
    const resultCard = document.getElementById('result-card');
    const resultContent = document.getElementById('result-content');
    const certificateLink = document.getElementById('certificate-link');

    const showError = (message) => {
        loadError.textContent = message;
        loadError.classList.remove('hidden');
    };

    const renderQuestions = (questions) => {
        questionsSection.innerHTML = '';
        questions.forEach((question, index) => {
            const wrapper = document.createElement('div');
            wrapper.className = 'bg-white rounded-2xl shadow p-6 border border-slate-100';
            wrapper.innerHTML = `
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                    ${index + 1}. ${question.text}
                </h3>
                <div class="space-y-3">
                    ${question.options.map(option => `
                        <label class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-slate-50">
                            <input type="radio" name="question-${question.id}" value="${option.id}"
                                   class="h-4 w-4 text-blue-600">
                            <span class="text-gray-700">${option.option_text}</span>
                        </label>
                    `).join('')}
                </div>
            `;
            questionsSection.appendChild(wrapper);
        });
        submitBtn.disabled = questions.length === 0;
    };

    const loadQuestions = async () => {
        try {
            const response = await fetch(`/test/${testId}/questions`, { credentials: 'include' });
            if (!response.ok) {
                if (response.status === 401) {
                    showError('–ß—Ç–æ–±—ã –ø—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É.');
                    return;
                }
                showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤–æ–ø—Ä–æ—Å—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
                return;
            }
            const questions = await response.json();
            renderQuestions(questions);
        } catch (error) {
            console.error(error);
            showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º.');
        }
    };

    const collectAnswers = () => {
        const answers = [];
        document.querySelectorAll('[name^="question-"]').forEach((input) => {
            if (input.checked) {
                const questionId = Number(input.name.replace('question-', ''));
                answers.push({ question_id: questionId, option_id: Number(input.value) });
            }
        });
        return answers;
    };

    submitBtn.addEventListener('click', async () => {
        submitBtn.disabled = true;
        resultCard.classList.add('hidden');
        const answers = collectAnswers();
        if (answers.length === 0) {
            showError('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –æ—Ç–≤–µ—Ç –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π.');
            submitBtn.disabled = false;
            return;
        }

        try {
            const response = await fetch(`/test/${testId}/questions/submit`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ test_id: testId, answers })
            });

            const data = await response.json();

            if (!response.ok) {
                showError(data.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç.');
                submitBtn.disabled = false;
                return;
            }

            resultContent.innerHTML = `
                <p>–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: <strong>${data.user_score}</strong> –∏–∑ <strong>${data.total_questions}</strong>.</p>
                <p>–ü—Ä–æ—Ü–µ–Ω—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: <strong>${data.user_score_percentage}%</strong>.</p>
                <p>${data.is_passed ? '–¢–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω, —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–æ—Å—Ç—É–ø–µ–Ω.' : '–¢–µ—Å—Ç –Ω–µ –ø—Ä–æ–π–¥–µ–Ω, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.'}</p>
            `;

            if (data.is_passed) {
                certificateLink.href = `/certificate/${data.attempt_id}`;
                certificateLink.classList.remove('hidden');
            } else {
                certificateLink.classList.add('hidden');
            }

            resultCard.classList.remove('hidden');
        } catch (error) {
            console.error(error);
            showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ç–µ—Å—Ç–∞.');
        } finally {
            submitBtn.disabled = false;
        }
    });

    loadQuestions();
</script>
</body>
</html>